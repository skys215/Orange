<!DOCTYPE html>
	<head>
		<meta charset="utf-8" />
		<title>Course</title>
	</head>
	<style>
		ul.ztree{
			display: inline-block;
			width: 300px;
			overflow: auto;
		}
		#timetables{
			background-color: rgba(255,255,255,0.6);
		}
		ul.schedule{
			background-color: rgba(255,255,30, 0.6);
			padding: 0 20px;
		}
		#timetables li{
			list-style-type: circle;
			list-style-position: inside;
		}
		li.schedule-case{
			padding: 10px;
			list-style-type: square;
			list-style-position: inside;
		}
	</style>
	<body>
		<ul id="all_course_list" class="ztree"></ul>
		<ul id="selected_course_list" class="ztree"></ul>
		<button id="start_arrange">Start!</button>
		<ul id="timetables"></ul>
	</body>
	<link rel="stylesheet" type="text/css" href="css/demo.css">
	<link rel="stylesheet" type="text/css" href="css/zTreeStyle/zTreeStyle.css">
	<script type="text/javascript" src="js/jquery-1.12.0.min.js"></script>
	<script type="text/javascript" src="js/ztree/jquery.ztree.all-3.5.min.js"></script>
	<script>
		var coursesTree;
		var slctdTree;
		var slctdCourses = [];
		function addNodeToSelected( nodes ){
			var parentNode;

			//if is parent, add directly
			if( nodes.isParent ){
				parentNode = slctdTree.copyNode(null, nodes );
				return false;
			}

			parentNode = slctdTree.getNodeByParam( 'cid', nodes.classname+nodes.college );
			//if parent doesn't exists, add parent node
			if( !parentNode ){
				parentNode = slctdTree.copyNode( null, nodes.getParentNode() );
				slctdTree.removeChildNodes( parentNode );
			}
			// append node to parent node
			slctdTree.copyNode( parentNode, nodes );
			// done
		}

		function removeNodeFromSelected( nodes ){
			var parentNode;
			var n = slctdTree.getNodeByParam( 'cid', nodes.cid );
			if( nodes.isParent ){
				slctdTree.removeChildNodes( n );
				slctdTree.removeNode( n );
			}
			else{
				slctdTree.removeNode( n );
				parentNode = slctdTree.getNodeByParam( 'cid', n.parentName );
				if( !parentNode.children.length ){
					slctdTree.removeNode( parentNode );
				}
			}
		}

		$(document).ready(function(){
			$.get('api.php',{action:'course_list'}, function( data ){
				var courseNodes = $.parseJSON( data );
				coursesTree = $.fn.zTree.init(
					$("#all_course_list"),
					{
						data: {
							simpleData: {
								enable: true,
								idKey: 'cid',
								pIdKey: 'parentName'
							}
						},
						check:{
							enable: true,
							autoCheckTrigger: false
						},
						callback: {
							onCheck:function(e, treeId, treeNode){
								if( treeNode.checked ){
									addNodeToSelected( treeNode );
								}
								else{
									removeNodeFromSelected( treeNode );
								}
							}
						}
					},
					courseNodes
				);
			});
			slctdTree = $.fn.zTree.init($("#selected_course_list"), {
				data: {
						simpleData: {
							enable: true,
							idKey: 'cid',
							pIdKey: 'parentName'
						}
					}
			}, []);
			$('#start_arrange').on('click', function(){
				var courses = JSON.stringify(getSelectedCIds());
				var data = {
					'action' : 'get_time_table',
					'courses': courses
				};
				$.get('api.php', data, function( result ){
					result = JSON.parse(result);
					showTimetables( result['timetables'] );
				});
			})
		});

		function getSelectedCIds( ){
			var courses = slctdTree.getNodesByParam('isParent', true);
			var courseIds = [];
			var i = 0;
			for( var parentNodeNum in courses ){
				courseIds[i] = [];
				var classes = courses[parentNodeNum].children;
				for( var classNum in classes ){
					courseIds[i].push( classes[classNum].cid );
				}
				i++;
			}
			return courseIds;
		}

		function showTimetables( possibleSchedules ){
			var ttList = $('#timetables');
			if( !possibleSchedules.length ){
				alert('no timetable matched');
				return false;
			}
			ttList.empty();
			var num = 1;
			for( var i in possibleSchedules ){
				var schedule = possibleSchedules[i];
				var prntLi = $('<li>').attr({'class':'schedule-case'}).text('方案'+num);
				var ul = $('<ul>').attr({'class':'schedule'});
				for( var k in schedule ){
					var course = schedule[k];
					var li = $('<li>').attr({'class':'schedule-course'}).text(course['classname']+course['cid']+'('+course['classroom']+')');
					ul.append( li );
				}
				num++;
				prntLi.append( ul );
				ttList.append( prntLi );
			}
		}
	</script>
</html>
