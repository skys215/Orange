<!DOCTYPE html>
	<head>
		<meta charset="utf-8" />
		<title>Course</title>
	</head>
	<style>
		*{
			box-sizing: content-box;
			padding: 0;
			margin: 0 auto;
			font-family: "Microsoft Yahei UI","Microsoft YaHei",Helvetica,Arial,sans-serif;
		}
		.container{
			width: 980px;
		}
		.container div{
			outline: 1px solid lime;
		}
		.left, .right{
			height: 85vh;
		}
		.left{
			width: 300px;
			float:left;
		}
		.right{
			margin-left: 300px;
		}
		#selectPage{
			background: khaki;
			padding: 0 auto;
			margin: auto 0;
		}
		#selectPage div{
			display: inline-block;
		}
		ul.ztree{
			height: 80vh;
			overflow: auto;
		}
		#all_course_list{
			display: none;
			position:absolute;
			margin-top: 20px;
			margin-left: 80px;
			background-color: lightsteelblue;
			box-shadow: 3px 3px 3px rgba(0,0,0,0.3);
			width: 380px;
		}
		#timetables{
			width: 80%;
			background-color: rgba(255,255,255,0.6);
		}
		#timetables td,#timetables th{
			border: 1px solid black;
		}
		ul.schedule{
			background-color: rgba(255,255,30, 0.6);
			padding: 0 20px;
		}
		#timetables li{
			list-style-type: circle;
			list-style-position: inside;
		}
		li.schedule-case{
			padding: 10px;
			list-style-type: square;
			list-style-position: inside;
		}

		#suggestions{
			position: absolute;
			margin: 0;
			padding: 0;

			background-color: salmon;
			box-shadow: 0px 3px 3px rgba(0,0,0,0.3);
			width: 500px;
			max-height: 80vh;
			margin-top: 20px;
			text-align: left;
			overflow: auto;
		}
		#suggestions:empty{
			display:none;
		}
		#suggestions li{
			padding: 12px;
			border-top: 1px solid lightgray;
			border-bottom: 1px solid lightgray;
		}
		.highlighted{
			background-color: yellow;
		}
	</style>
	<body>
		<div class="container">
			<div id="selected_course" class="left">
				<div>
					<ul id="suggestions"></ul>
					<ul id="all_course_list" class="ztree"></ul>
					<input type="text" placeholder="搜索课程" id="keyword"/>
					<a href="#" class="show_all_class">所有课程</a>
				</div>
				<div>已选课程：<button id="start_arrange">Start!</button></div>
				<ul id="selected_course_list" class="ztree"></ul>
			</div>
			<div id="resultPage" class="right">
				<select id="ttList"></select>
				<table id="timetables">
				</table>
			</div>
		</div>
	</body>
	<!-- <link rel="stylesheet" type="text/css" href="css/demo.css"> -->
	<link rel="stylesheet" type="text/css" href="css/zTreeStyle/zTreeStyle.css">
	<script type="text/javascript" src="js/jquery-1.12.0.min.js"></script>
	<script type="text/javascript" src="js/ztree/jquery.ztree.all-3.5.min.js"></script>
	<script>
		var coursesTree;
		var slctdTree;
		var slctdCourses = [];
		var weekDays = [ '星期一', '星期二', '星期三', '星期四', '星期五' ];
		var dayClasses = ['-', 1,2,3,4,'午休',5,6,7,8,'5:30-7:00',9,10,11,12];
		var dayClsKeys = [0,1,2,3,4,'noon',5,6,7,8, 13, 9,10,11,12];
		function addNodeToSelected( nodes ){
			var parentNode;

			//if is parent, add directly
			if( nodes.isParent ){
				parentNode = slctdTree.copyNode(null, nodes, 'next', false );
				for( var i in parentNode.children){
					addClassToTimeTable( parentNode.children[i] );
				}
				return false;
			}

			parentNode = slctdTree.getNodeByParam( 'cid', nodes.classname+nodes.college );
			//if parent doesn't exists, add parent node
			if( !parentNode ){
				parentNode = slctdTree.copyNode( null, nodes.getParentNode() );
				slctdTree.removeChildNodes( parentNode );
			}
			// append node to parent node
			slctdTree.copyNode( parentNode, nodes );
			// done
			addClassToTimeTable( nodes );
		}

		function removeNodeFromSelected( nodes ){
			$('div.cid_'+nodes.cid).remove();

			var parentNode;
			var n = slctdTree.getNodeByParam( 'cid', nodes.cid );
			if( nodes.isParent ){
				slctdTree.removeChildNodes( n );
				slctdTree.removeNode( n );
			}
			else{
				slctdTree.removeNode( n );
				parentNode = slctdTree.getNodeByParam( 'cid', n.parentName );
				if( !parentNode.children.length ){
					slctdTree.removeNode( parentNode );
				}
			}
		}

		function addNode( ){
			var ele = ul.find('li.highlighted');
			ul.empty();
			$('#keyword').val('');
			var cid = ele.attr('data-cid');

			var node = coursesTree.getNodeByParam('cid', cid );
			if( node.length > 0 ){
				addNodeToSelected( node[0] );
			}
		}

		function addClassToTimeTable( node ){
			// var times;
			times = Number(node.courseTimeSing).toString(2);
			//pad 60;
			var pre = 60-times.length;
			// everyday
			var st = -1;//start from top
			while( (ind = times.indexOf('1', st+1))>=0 ){
				var sameTimeClass = $('div.'+node.classname+'-'+node.college);
				if( sameTimeClass ){

				}
				ind +=pre;
				var clsDiv = $('<div>')
					.addClass('cid_'+node.cid)
					.addClass(node.classname+'-'+node.college)
					.text(node.classname+'('+node.cid+')');
				var d = Math.floor(ind/12)+1;
				var t = ind%12+1;
				st = ind-pre;
				$('#timetables td.day_'+d+'.class_'+t).append( clsDiv );
			}
		}

		$(document).ready(function(){
			$.get('api.php',{action:'course_list'}, function( data ){
				var courseNodes = $.parseJSON( data );
				coursesTree = $.fn.zTree.init(
					$("#all_course_list"),
					{
						data: {
							simpleData: {
								enable: true,
								idKey: 'cid',
								pIdKey: 'parentName'
							},
							key:{
								title:'title'
							}
						},
						check:{
							enable: true,
							autoCheckTrigger: false
						},
						callback: {
							onCheck:function(e, treeId, treeNode){
								if( treeNode.checked ){
									addNodeToSelected( treeNode );
								}
								else{
									removeNodeFromSelected( treeNode );
								}
							}
						}
					},
					courseNodes
				);
			});
			slctdTree = $.fn.zTree.init($("#selected_course_list"), {
				data: {
					simpleData: {
						enable: true,
						idKey: 'cid',
						pIdKey: 'parentName'
					},
					key:{
						title: 'title'
					}
				},
				callback:{
					beforeRemove: function( treeId, treeNode ){
						if( treeNode.isParent == false && treeNode.getParentNode().children.length <=1 ){
							slctdTree.removeNode( treeNode.getParentNode() );
						}
					},
					onRemove:function( event, treeId, treeNode ){
						var cTNode = coursesTree.getNodeByParam('cid', treeNode.cid);
						if( !cTNode ){
							return ;
						}

						coursesTree.checkNode( cTNode, false, true );
					},
					onNodeCreated: function(event, treeId, nodes ){
						if( nodes.isParent ){
							slctdTree.expandNode( nodes, true, false, true );
							return;
						}
						//parseTime
						//checkul
						//addli
						//hide

					}
				},
				edit: {
					enable:true,
					showRenameBtn: false
				}
			}, []);

			$('.show_all_class').on('click', function(){
				$('#all_course_list').toggle();
			});

			$('#start_arrange').on('click', function(){
				var courses = JSON.stringify(getSelectedCIds());
				var data = {
					'action' : 'get_time_table',
					'courses': courses
				};
				$.get('api.php', data, function( result ){
					result = JSON.parse(result);
					showTimetables( result['timetables'] );
				});
			});

			$('#keyword').on('keyup change', function( e ){
				var t = $(this).val();
				if( t.length <2 ){
					ul.empty();
					return ;
				}
				switch( e.keyCode ){
					case KEY_UP:
						e.preventDefault();
						previousItem();
						break;
					case KEY_DOWN:
						e.preventDefault();
						nextItem();
						break;
					case KEY_ENTER:
						addNode();
					case KEY_BACKSPACE:
						break;
					default:
						getResult( t );
						break;
				}
			});
			$('#keyword').on('blur', function(){
				ul.empty();
			});

			genTimetable();
		});

		function getResult( keyword ){
			var d = new Date().getTime();
			$.get('api.php', {"action":'search', 'keyword': keyword, 'd': d }, function( data ){
				data = $.parseJSON( data );
				ul.empty();

				var lis = [];
				for( var item in data.result ){
					var cls = data.result[item];
					lis.push( '<li class="sug-item" data-cid="'+cls.cid+'" data-classname="'+cls.classname+'" data-college="'+cls.college+'" data-classteacher="'+cls.classteacher+'" data-classroom="'+cls.classroom+'">'+cls.cid+'('+cls.college+'):<br />'+cls.classname+'-'+cls.classteacher+'<br />上课时间：'+cls.classroom+'</li>' );
				}
				totalItemNum = lis.length;
				ul.html(lis.join("\n"));
				ul.find('li:first-child').addClass('highlighted');
			});
		}

		var KEY_UP = 38;
		var KEY_DOWN = 40;
		var KEY_ENTER = 13;
		var KEY_BACKSPACE = 8;
		var KEY_SPACE = 20;

		var ul = $('#suggestions');
		var crntItemNum = 0;
		var totalItemNum = 0;
		function previousItem(){
			ul.find('li.highlighted').removeClass('highlighted');
			if( crntItemNum >0 ){
				crntItemNum--;
				var slctdLi = ul.find('li.sug-item:nth-child('+crntItemNum+')');
				if( ul[0].scrollTop > slctdLi[0].offsetTop ){
					ul[0].scrollTop = slctdLi[0].offsetTop;
				}
				slctdLi.addClass('highlighted');
			}
		}

		function nextItem(){
			ul.children('.highlighted').removeClass('highlighted');

			if( crntItemNum < totalItemNum ){
				crntItemNum++;
			}
			var slctdLi = ul.find('li.sug-item:nth-child('+crntItemNum+')');
			if( (slctdLi[0].offsetTop + slctdLi[0].offsetHeight) > (ul[0].scrollTop +ul[0].offsetHeight ) ){
				ul[0].scrollTop = ul[0].scrollTop + slctdLi[0].offsetHeight;
			}
			slctdLi.addClass('highlighted');
		}

		function getSelectedCIds(){
			var courses = slctdTree.getNodesByParam('isParent', true);
			var courseIds = [];
			var i = 0;
			for( var parentNodeNum in courses ){
				courseIds[i] = [];
				var classes = courses[parentNodeNum].children;
				for( var classNum in classes ){
					courseIds[i].push( classes[classNum].cid );
				}
				i++;
			}
			return courseIds;
		}

		function showTimetables( possibleSchedules ){
			var ttList = $('#ttList');
			if( !possibleSchedules.length ){
				alert('no timetable matched');
				return false;
			}
			ttList.empty();
			var num = 1;
			for( var i in possibleSchedules ){
				var schedule = possibleSchedules[i];
				var prntLi = $('<li>').attr({'class':'schedule-case'}).text('方案'+num);
				var ul = $('<ul>').attr({'class':'schedule'});
				for( var k in schedule ){
					var course = schedule[k];
					var li = $('<li>').attr({'class':'schedule-course'}).text(course['classname']+course['cid']+'('+course['classroom']+')');
					ul.append( li );
				}
				num++;
				prntLi.append( ul );
				ttList.append( prntLi );
			}
		}

		function genTimetable(){
			var cells = [];
			for( var i in dayClasses ){

				var tr = $('<tr>');
				var th = [];
				if( i == 0 ){
					th.push( $('<th>').text( '-' ) );
					for( var j in weekDays ){
						th.push( $('<th>').text( weekDays[j] ) );
					}
				}
				else{
					th.push( $('<th>').addClass('class_'+dayClsKeys[i]).text( dayClasses[i] ) );
					for( var j in weekDays ){
						th.push( $('<td>').addClass('day_'+(Number(j)+1)).addClass('class_'+dayClsKeys[i]) );
					}
				}
				tr.addClass('class_'+dayClsKeys[i]);
				tr.append( th );
				$('#timetables').append( tr );
			}
		}
	</script>
</html>
